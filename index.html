<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vibe IDE â€” Orb v1.3.4</title>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{ --panel:#0a0f1c; --border:#00ffc3; --bg: #0b1220; --text:#f4f4f4; --muted:#9aa4b2; }
    html,body{height:100%;margin:0;background:linear-gradient(120deg,#0b1220,#101a33);color:var(--text);font-family:"IBM Plex Sans",system-ui}
    .app{display:grid;grid-template-columns:2fr 1fr;grid-template-rows:auto 1fr auto;gap:16px;padding:20px;height:100%}
    header{display:flex;align-items:center;gap:12px}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:9999px;padding:6px 12px;background:rgba(0,255,195,.06)}
    .pill img{width:16px;height:16px}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.35);overflow:hidden;display:flex;flex-direction:column}
    .panel header{justify-content:space-between;padding:10px 14px;border-bottom:1px solid var(--border);font-family:"IBM Plex Mono",monospace;color:var(--muted)}
    .editor{height:100%}
    textarea{flex:1;background:#0b1220;color:var(--text);border:0;outline:none;padding:14px 16px;font-family:"IBM Plex Mono",monospace;font-size:13.5px}
    iframe{border:0;background:#fff;width:100%;height:100%}
    .actions{display:flex;gap:8px;align-items:center}
    button{all:unset;cursor:pointer}
    .btn{padding:8px 12px;border-radius:8px;border:1px solid var(--border);color:var(--border);background:rgba(0,255,195,.06);font-weight:600}
    .btn.primary{background:linear-gradient(135deg,#2bf4c8,#00ffc3);color:#0b1220;border-color:transparent}
    .grid{display:grid;grid-template-columns:1fr;grid-auto-rows:minmax(220px,1fr);gap:16px}
    .footer{grid-column:1/-1;text-align:center;color:var(--muted);font-size:12px}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:1000}
    .modal{width:min(720px,95vw);max-height:80vh;overflow:auto;background:#0b1220;border:1px solid var(--border);border-radius:12px;padding:16px}
    .modal h3{margin:0 0 8px 0}
    .log{font-family:"IBM Plex Mono",monospace;background:#06101a;border:1px solid #08313a;border-radius:8px;padding:12px;white-space:pre-wrap;max-height:50vh;overflow:auto}
    @media (max-width: 1100px){ .app{grid-template-columns:1fr} .grid{grid-auto-rows:minmax(300px,1fr)} }
  </style>
</head>
<body>
<div class="app">
  <header>
    <span class="pill"><img src="icons/launch.svg" alt="launch"/> live vibe</span>
    <strong>Vibe IDE â€” Orb v1.3.4</strong>
  </header>

  <div class="panel" style="grid-row:2 / span 1;">
    <header>
      <span>index.html â€” Editor</span>
      <div class="actions">
        <button id="btnShare" class="btn" title="Copy live link">Share ðŸ“£</button>
        <button id="btnExport" class="btn" title="Download project zip">Export ðŸ“¦</button>
        <button id="btnPush" class="btn primary" title="Push to Live">Push ðŸš€</button>
      </div>
    </header>
    <div class="editor">
      <textarea id="editor"></textarea>
    </div>
  </div>

  <div class="panel" style="grid-row:2 / span 1;">
    <header><span>Preview</span></header>
    <div class="editor">
      <iframe id="pip"></iframe>
    </div>
  </div>

  <div class="footer">Initial vibes manifested â€” remix or paste your HTML. Auto-refresh after publish is enabled.</div>
</div>

<div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h3>Publish results</h3>
      <button id="btnCloseModal" class="btn">Close</button>
    </div>
    <pre id="publishLog" class="log"></pre>
  </div>
</div>

<script>
(function(){
  const dom = {
    ed: document.getElementById('editor'),
    pip: document.getElementById('pip'),
    btnPush: document.getElementById('btnPush'),
    btnExport: document.getElementById('btnExport'),
    btnShare: document.getElementById('btnShare'),
    modal: document.getElementById('modalBackdrop'),
    btnCloseModal: document.getElementById('btnCloseModal'),
    log: document.getElementById('publishLog')
  };

  const DEFAULT_SAMPLE = `<!doctype html><html><head><meta charset="utf-8"><title>Sample</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;600&display=swap" rel="stylesheet">
<style>body{font-family:'IBM Plex Sans',system-ui;margin:0;padding:40px}h1{letter-spacing:.04em}</style></head>
<body><h1>Initial vibes manifested</h1><p>Remix your vibe: edit in Vibe IDE or paste your own HTML.</p></body></html>`;

  function setPreview(html){
    const blob = new Blob([html], {type:'text/html'});
    const url = URL.createObjectURL(blob);
    dom.pip.src = url;
  }

  function loadSaved(){
    const saved = localStorage.getItem('vibe.page');
    dom.ed.value = saved || DEFAULT_SAMPLE;
    setPreview(dom.ed.value);
  }

  function saveAndPreview(){
    localStorage.setItem('vibe.page', dom.ed.value);
    setPreview(dom.ed.value);
  }

  async function exportZip(){
    const zipName = 'vibe-site.zip';
    const files = {
      'index.html': dom.ed.value,
      'assets/env.js': (window.__VIBE_ENV__ ? 'window.__VIBE_ENV__='+JSON.stringify(window.__VIBE_ENV__) : 'window.__VIBE_ENV__={};')
    };
    const zipBlob = await buildZip(files);
    const a = document.createElement('a');
    a.href = URL.createObjectURL(zipBlob);
    a.download = zipName;
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
  }

  async function buildZip(files){
    if (!window.JSZip){
      const parts = ['/* Fallback: index.html only */\n', files['index.html'] || ''];
      return new Blob(parts, {type:'application/zip'});
    }
    const zip = new JSZip();
    for (const [k,v] of Object.entries(files)) zip.file(k, v);
    return zip.generateAsync({type:'blob'});
  }

  function showModal(text){
    dom.log.textContent = text || '';
    dom.modal.style.display = 'flex';
    dom.modal.setAttribute('aria-hidden', 'false');
  }
  function hideModal(){
    dom.modal.style.display = 'none';
    dom.modal.setAttribute('aria-hidden', 'true');
  }

  async function copyLiveLink(){
    try{
      const env = (window.__VIBE_ENV__||{});
      const link = (env.PRIMARY_OUTPUT_LINK || env.PROJECT_URL || location.href.split('#')[0]);
      await navigator.clipboard.writeText(link);
      dom.btnShare.textContent = 'Copied âœ…';
      setTimeout(()=>dom.btnShare.textContent='Share ðŸ“£', 1400);
    }catch(e){
      dom.btnShare.textContent = 'Copy failed';
      setTimeout(()=>dom.btnShare.textContent='Share ðŸ“£', 1400);
    }
  }

  function refreshLivePreview(liveUrl){
    const cacheBust = (u)=>{
      try{
        const url = new URL(u);
        url.searchParams.set('_vibe', Date.now().toString(36));
        return url.toString();
      }catch(_){ return u; }
    };
    const target = liveUrl || (window.__VIBE_ENV__ && window.__VIBE_ENV__.PRIMARY_OUTPUT_LINK);
    if (target){
      dom.pip.src = cacheBust(target);
    }
  }

  async function doPush(){
    const env = (window.__VIBE_ENV__||{});
    const BROKER = env.PUSH_API_URL;
    if (!BROKER){
      showModal('No PUSH_API_URL configured in env.js');
      return;
    }
    const form = new FormData();
    form.append('bucket', env.BUCKET_NAME || '');
    form.append('region', env.REGION || '');
    form.append('key', 'sample.html');
    form.append('file', new Blob([dom.ed.value], {type:'text/html'}), 'sample.html');

    let log = `POST ${BROKER}/publish\n`;
    try{
      const res = await fetch(`${BROKER}/publish`, { method:'POST', body: form });
      const text = await res.text();
      log += `Status: ${res.status}\n\n${text}`;
      showModal(log);
      try{
        const j = JSON.parse(text);
        const live = j.website || j.url || j.public_url || j.website_endpoint || env.PRIMARY_OUTPUT_LINK;
        if (live) refreshLivePreview(live);
      }catch(_){
        refreshLivePreview(env.PRIMARY_OUTPUT_LINK);
      }
    }catch(e){
      log += `\nERROR: ${e.message}`;
      showModal(log);
    }
  }

  dom.ed.addEventListener('input', saveAndPreview);
  dom.btnExport.addEventListener('click', exportZip);
  dom.btnPush.addEventListener('click', doPush);
  dom.btnShare.addEventListener('click', copyLiveLink);
  dom.btnCloseModal.addEventListener('click', hideModal);

  const envScript = document.createElement('script');
  envScript.src = 'assets/env.js';
  document.head.appendChild(envScript);

  loadSaved();
})();
</script>
</body>
</html>