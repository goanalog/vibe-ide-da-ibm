export async function vibeAPI(path, options = {}) {
  const base = (window.VIBE_CONFIG && window.VIBE_CONFIG.CODE_ENGINE_URL) || "";
  if (!base) throw new Error("CODE_ENGINE_URL is not set. env.js should be generated by Terraform.");
  const url = `${base}${path}`;
  const init = {
    method: options.method || "POST",
    headers: { "Content-Type": "application/json" },
    body: options.method === "GET" ? undefined : JSON.stringify(options.body || {}),
  };
  const res = await fetch(url, init);
  if (!res.ok) { throw new Error(`API error ${res.status}: ${await res.text()}`); }
  const ct = res.headers.get("content-type") || "";
  return ct.includes("application/json") ? res.json() : { raw: await res.text() };
}

export async function loadFromBucket() {
  const base = (window.VIBE_CONFIG && window.VIBE_CONFIG.CODE_ENGINE_URL) || "";
  const res = await fetch(`${base}/load`, { method: "GET" });
  if (!res.ok) throw new Error(`API error ${res.status}`);
  return res.json();
}
export async function manifestHTML(html) { return vibeAPI("/manifest/text", { body: { html } }); }
export async function pushToBucket(html)   { return vibeAPI("/push",          { body: { html } }); }
export async function pushToProject(html)  { return vibeAPI("/push/project",  { body: { html } }); }
export async function forkMyOwn()          { return vibeAPI("/fork",          { method: "POST" }); }