<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Instant Data Lake — Helper App</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;600&display=swap" rel="stylesheet"/>

<style>
  :root {
    --bg: #ffffff;
    --fg: #161616;
    --muted: #6f6f6f;
    --brand: #0f62fe;
    --brand-20: #edf5ff;
    --surface: #f4f4f4;
    --border: #e0e0e0;
    --success: #24a148;
  }
  * { box-sizing: border-box; }
  body { margin: 0; min-height: 100vh; display: flex; background: var(--bg); color: var(--fg); font-family: "IBM Plex Sans", system-ui, sans-serif; }
  header { width: 260px; background: #161616; color: #fff; padding: 20px; }
  header h1 { margin: 0 0 12px; font-size: 1.3rem; }
  header .sub { color: #bdbdbd; font-size: .9rem; margin-bottom: 10px; }
  header button { width: 100%; margin: 6px 0; padding: 10px 12px; font-weight: 600; background: var(--brand); color: #fff; border: none; border-radius: 8px; cursor: pointer; }
  header button.secondary { background: #393939; }
  main { flex: 1; padding: 20px; display: flex; flex-direction: column; gap: 16px; }

  .shimmer { position: relative; overflow: hidden; background: var(--surface); border-radius: 8px; }
  .shimmer::after { content: ""; position: absolute; inset: 0; transform: translateX(-100%);
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
    animation: shimmer 1.2s infinite; }
  @keyframes shimmer { 100% { transform: translateX(100%); } }

  .list { display: grid; grid-template-columns: repeat(2, minmax(200px, 1fr)); gap: 10px; }
  .item { padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; background: #fff; cursor: pointer; }
  .item.active { outline: 2px solid var(--brand); background: var(--brand-20); }
  .item small { color: var(--muted); display: block; }

  pre { background: #0b0b0b; color: #e5e5e5; padding: 16px; border-radius: 8px; overflow: auto; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: .85rem; }

  #help { display: none; border: 1px solid var(--border); background: #fff; border-radius: 10px; padding: 16px; }
  #help p { margin: .5rem 0; }
  #help .ok { color: var(--success); font-weight: 600; }

  a { color: var(--brand); text-decoration: none; }
  .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
  .pill { display: inline-block; padding: 4px 8px; background: var(--brand-20); color: var(--brand); border-radius: 999px; font-size: .8rem; }
  .muted { color: var(--muted); }

  @media (max-width: 840px) {
    body { flex-direction: column; }
    header { width: 100%; }
    .list { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>
  <header>
    <h1>Instant Data Lake</h1>
    <div class="sub">Serverless helper app</div>
    <button onclick="toggleHelp()">Show Help</button>
    <button class="secondary" onclick="copyLink()">Share Link</button>
    <button class="secondary" onclick="openBucket()">Open Bucket</button>
  </header>

  <main>
    <div id="help">
      <p class="ok">✅ Your Data Lake is ready.</p>
      <p>Explore sample CSVs, share this app’s live URL, or jump to the COS bucket in the IBM Cloud console.</p>
      <div class="row">
        <span class="pill">Tip</span>
        <span>First file auto-opens after list loads.</span>
      </div>
      <p class="muted">Repo: <a href="https://github.com/goanalog/instant-data-lake-da" target="_blank" rel="noopener">goanalog/instant-data-lake-da</a></p>
    </div>

    <div class="row">
      <h2 style="margin:0">Bucket: <span id="bucketTitle">{{ bucket }}</span></h2>
      <span class="pill">{{ region }}</span>
    </div>

    <div id="filesShimmer" class="shimmer" style="height:64px;"></div>
    <div id="files" class="list" style="display:none"></div>

    <h3 id="previewTitle" style="display:none"></h3>
    <pre id="preview" style="display:none"></pre>
  </main>

<script>
const bucket = "{{ bucket }}";
const region = "{{ region }}";
const bucketConsoleUrl = "{{ bucket_console_url }}";

function toggleHelp() {
  const el = document.getElementById("help");
  el.style.display = el.style.display === "block" ? "none" : "block";
}
function copyLink() {
  navigator.clipboard.writeText(window.location.href);
  alert("Link copied ✅");
}
function openBucket() { window.open(bucketConsoleUrl, "_blank"); }

fetch("/api/files")
  .then(r => r.json())
  .then(files => {
    const shimmer = document.getElementById("filesShimmer");
    const list = document.getElementById("files");
    shimmer.style.display = "none";
    list.style.display = "grid";
    list.innerHTML = "";

    if (!files || files.length === 0) {
      list.innerHTML = "<div class='muted'>No CSV files found in this bucket.</div>";
      return;
    }

    files.forEach((f, idx) => {
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `<strong>${f}</strong><small>CSV</small>`;
      div.onclick = () => selectFile(idx, f);
      list.appendChild(div);
    });

    selectFile(0, files[0]);
  });

function selectFile(index, key) {
  document.querySelectorAll(".item").forEach((el, i) => {
    el.classList.toggle("active", i === index);
  });

  fetch("/api/file/" + encodeURIComponent(key))
    .then(r => r.text())
    .then(text => {
      document.getElementById("previewTitle").style.display = "block";
      document.getElementById("preview").style.display = "block";
      document.getElementById("previewTitle").innerText = key;
      document.getElementById("preview").innerText = text;
    })
    .catch(() => {
      document.getElementById("previewTitle").innerText = key + " (error loading)";
    });
}
</script>
</body>
</html>
